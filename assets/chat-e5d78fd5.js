import{o as h,f as S}from"./openai-25cd8fc5.js";import{M as E,H as C}from"./history-ea154c10.js";import{a as N}from"./el-col-61dfbaf8.js";import{a8 as T,x as V,b as k,y as D,a9 as R,aa as F,ab as I,a3 as _,ac as M,ad as B,d as H,Q as L,R as O,a1 as d,w as U,a as i,o as J,a4 as K}from"./index-7bab1c5f.js";import"./el-icon-e3175369.js";const P=T("chat-store",()=>{const g=V([{name:"model",key:"model",type:"select",options:[{name:"gpt-4",value:"gpt-4"},{name:"gpt-4-0314",value:"gpt-4-0314"},{name:"gpt-4-32k",value:"gpt-4-32k"},{name:"gpt-4-32k-0314",value:"gpt-4-32k-0314"},{name:"gpt-3.5-turbo",value:"gpt-3.5-turbo"},{name:"gpt-3.5-turbo-0301",value:"gpt-3.5-turbo-0301"}],default:"gpt-3.5-turbo"},{name:"system",key:"system",type:"textarea",default:""},{name:"是否启用流传输",key:"stream",type:"switch",default:!0},{name:"temperature(默认为1)不建议和top_p一起改",key:"temperature",type:"slider",range:{start:0,end:2,step:.1},default:1},{name:"top_p(默认为1)",key:"top_p",type:"slider",range:{start:0,end:1,step:.1},default:1},{name:"stop",key:"stop",type:"input",default:""},{name:"最大生成令牌数，设置-1表示无限",key:"max_tokens",type:"number",range:{start:-1,end:32e3,step:1},default:-1},{name:"谈论新主题可能性，默认为0",key:"presence_penalty",type:"slider",range:{start:-2,end:2,step:.1},default:0},{name:"重复同样的话的可能。默认为0",key:"frequency_penalty",type:"slider",range:{start:-2,end:2,step:.1},default:0}]),s=[{name:"新对话",key:"new"},{name:"根据启用的信息生成",key:"reGen"},{name:"历史记录",key:"history"}],a=k({});{let e;const t="chatOption";(()=>{const m=localStorage.getItem(t);let l={};m&&(l=JSON.parse(m)),g.forEach(n=>{Object.hasOwn(l,n.key)?a.value[n.key]=l[n.key]:a.value[n.key]=n.default})})(),D(a,()=>{clearTimeout(e),e=setTimeout(()=>{localStorage.setItem(t,JSON.stringify(a.value))},1e3)},{deep:!0})}const o=k([]),f=e=>{o.value.push({role:"user",content:e,headPosition:"right",status:!0})},y=()=>{const e=[];return a.value.system&&e.push({role:"system",content:a.value.system}),o.value.forEach(t=>{t.status&&e.push({role:t.role,content:t.content})}),e},r=()=>{const e={...a.value};return delete e.system,e.max_tokens===-1&&(e.max_tokens=1/0),{...e,messages:y()}},c=()=>{for(let e=o.value.length-1;e>=0&&(o.value[e].status=!1,o.value[e].role!=="user");e--);},u=async()=>{const e=R("请稍等");try{return await h.streamApi("chat",{...r()},{apiKey:h.apiKey.value})}catch(t){if(t instanceof Error){if(t instanceof F)return I(t);_.error(t.message),M({title:"stream error",message:"如果你想知道确切的原因，最好不要使用流模式",duration:0})}throw t}finally{B(e)}},p=async e=>{try{const t=e.getReader(),w=new TextDecoder;let m=!0,l={},n;const b=1*60*1e3;o.value.push({role:"assistant",headPosition:"left",status:!0,content:""});do{let A=setTimeout(async()=>{throw t.releaseLock(),await e.cancel("timeout"),new Error("stream read error")},b);n=await t.read(),clearTimeout(A),m=n.done,l={},n.value&&(l=JSON.parse(w.decode(n.value))),Object.hasOwn(l,"content")&&(o.value[o.value.length-1].content+=l.content)}while(!m);_.success("done!")}catch(t){if(t instanceof Error&&t.type==="MAX_TOKENS"){_.warning("达到最大token"),M({title:"stream error",message:t.message});return}throw t}},x=async()=>{try{const e=await h.openAiAPi.createChatCompletion({...r()}),t={role:"assistant",headPosition:"left",content:e.data.choices[0].message.content,status:!0,usage:e.data.usage};o.value.push(t)}catch(e){throw e}},v=async()=>{try{if(a.value.stream){const e=await u();await p(e)}else await x()}catch(e){throw c(),e}};return{formData:a,options:g,actionList:s,chatMessages:o,chat:async e=>{f(e),await v()},createAssistantMessage:v}}),q={class:"container"},G={class:"option"},j={class:"frame"},Q=H({__name:"chat",setup(g){const s=P(),a=k(),o=r=>{var c,u;switch(r){case"new":(c=a.value)==null||c.closeCurrentGroup();break;case"reGen":s.createAssistantMessage();break;case"history":(u=a.value)==null||u.openHistory();break}},f=r=>{s.chatMessages.splice(r,1)},y=r=>{s.chat(r)};return(r,c)=>{const u=S;return J(),L("div",q,[O("div",G,[d(u,{offset:60},{default:U(()=>[d(N,{modelValue:i(s).formData,"onUpdate:modelValue":c[0]||(c[0]=p=>i(s).formData=p),options:i(s).options,title:"选项"},null,8,["modelValue","options"])]),_:1})]),O("div",j,[d(E,{showStatus:!0,"chat-messages":i(s).chatMessages,"action-list":i(s).actionList,onOnUserInput:y,onOnOperateAct:o,onOnClickCloseSingleMessage:f},null,8,["chat-messages","action-list"])]),d(C,{modelValue:i(s).chatMessages,"onUpdate:modelValue":c[1]||(c[1]=p=>i(s).chatMessages=p),"storage-key":"chat-history",ref_key:"historyRef",ref:a},null,8,["modelValue"])])}}});const ee=K(Q,[["__scopeId","data-v-24826224"]]);export{ee as default};
